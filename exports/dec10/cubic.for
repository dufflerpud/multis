C	@HDR@	$Id$
C	@HDR@		Copyright 1982-2025 by
C	@HDR@		Christopher Caldwell/Brightsands
C	@HDR@		P.O. Box 401, Bailey Island, ME 04003
C	@HDR@		All Rights Reserved
C	@HDR@
C	@HDR@	This software comprises unpublished confidential information
C	@HDR@	of Brightsands and may not be used, copied or made available
C	@HDR@	to anyone, except in accordance with the license under which
C	@HDR@	it is furnished.
C	*** CUBIC.FOR ***
	SUBROUTINE FMAIN

	IMPLICIT INTEGER ( A - Z )

	INTEGER WR(76,4), MOVE(4,4,4), COM(60), PAR(20)
	INTEGER COMOV( 2 ), MOVES( 64, 3 ), TURN, IPL, PLAYER
	LOGICAL COORD, ERRFLG, PRIVD
	INTEGER FILESP(13)

	COMMON /COL/ICLWHI,ICLDBL,ICLRED,ICLLBL,
     &			ICLPUR,ICLGRE,ICLYEL,ICLBLA

	DATA ( ( WR(I,J), J=1,4 ), I=1,76 )/
     &111,121,131,141,211,221,231,241,311,321,331,341,411,421,431,441,
     &111,211,311,411,121,221,321,421,131,231,331,431,141,241,341,441,
     &111,221,331,441,411,321,231,141,112,122,132,142,212,222,232,242,
     &312,322,332,342,412,422,432,442,112,212,312,412,122,222,322,422,
     &132,232,332,432,142,242,342,442,112,222,332,442,412,322,232,142,
     &113,123,133,143,213,223,233,243,313,323,333,343,413,423,433,443,
     &113,213,313,413,123,223,323,423,133,233,333,433,143,243,343,443,
     &113,223,333,443,413,323,233,143,114,124,134,144,214,224,234,244,
     &314,324,334,344,414,424,434,444,114,214,314,414,124,224,324,424,
     &134,234,334,434,144,244,344,444,114,224,334,444,414,324,234,144,
     &111,112,113,114,121,122,123,124,131,132,133,134,141,142,143,144,
     &211,212,213,214,221,222,223,224,231,232,233,234,241,242,243,244,
     &311,312,313,314,321,322,323,324,331,332,333,334,341,342,343,344,
     &411,412,413,414,421,422,423,424,431,432,433,434,441,442,443,444,
     &111,122,133,144,114,123,132,141,211,222,233,244,214,223,232,241,
     &311,322,333,344,314,323,332,341,411,422,433,444,414,423,432,441,
     &111,212,313,414,114,213,312,411,121,222,323,424,124,223,322,421,
     &131,232,333,434,134,233,332,431,141,242,343,444,144,243,342,441,
     &111,222,333,444,411,322,233,144,141,232,323,414,114,223,332,441/

	IF( ICLWHI .NE. 0 ) GOTO 3
	ICLWHI = 1
	ICLDBL = 2
	ICLRED = 3
	ICLLBL = 4
	ICLPUR = 5
	ICLGRE = 6
	ICLYEL = 7
	ICLBLA = 8

3	CALL PBACK( ICLBLA )
	CALL PCOLOR( ICLWHI )
	CALL SETTTY( COM, PAR, ILEN, PRIVD, FILESP )
	IF( ILEN.GT.0 .AND. ISERCH( PAR,ISXBIT('DEBUG'),ILEN ).NE.0
     & .AND. PRIVD ) GOTO 1000
100	CALL STRING('Do you want the computer to go first? ^B')
	CALL GETSTR( COM, 60, ILEN )
	IF( ILEN .EQ. 0 ) GOTO 100
	CALL ALLCAP( COM, ILEN )
	IF( COM(1) .NE. 'Y' .AND. COM(1) .NE. 'N' ) GOTO 100
	COMOV(1) = COM(1)

200	CALL STRING('Do you want the computer to go second? ^B')
	CALL GETSTR( COM, 60, ILEN )
	IF( ILEN .EQ. 0 ) GOTO 200
	CALL ALLCAP( COM, ILEN )
	IF( COM(1) .NE. 'Y' .AND. COM(1) .NE. 'N' ) GOTO 200
	COMOV(2) = COM(1)

250	CALL STRING('Do you want the coordinates printed? ^B')
	CALL GETSTR( COM, 60, ILEN )
	IF( ILEN .EQ. 0 ) GOTO 250
	CALL ALLCAP( COM, ILEN )
	IF( COM(1) .NE. 'Y' .AND. COM(1) .NE. 'N' ) GOTO 250
	COORD = .TRUE.
	IF( COM(1) .EQ. 'N' ) COORD = .FALSE.

	CALL UPDSCR( MOVES, MOVE, .TRUE., COORD )
	PLAYER = 1

300	CALL GETMOV(COM,MOVE,WR,PLAYER,COMOV(PLAYER),COORD,MOVES,TURN)
	CALL EVAL( WR, MOVE, IPL )
	CALL UPDSCR( MOVES, MOVE, .FALSE., COORD )
	PLAYER = 3-PLAYER
	IF( IPL .LT. 0 ) GOTO 300

400	CALL CURSOR( 1, 2 )
	IF( IPL .EQ. 0 )
     &CALL STRING('Stalemate.                             ^M^J^E')
	IF( IPL .EQ. 1 )
     &CALL STRING('X wins.                                ^M^J^E')
	IF( IPL .EQ. 2 )
     &CALL STRING('O wins.                                ^M^J^E')
500	CALL STRING('Do you want to play again?  ^B')
	CALL GETSTR( COM, 60, ILEN )
	IF( ILEN .EQ. 0 ) GOTO 500
	CALL ALLCAP( COM, ILEN )
	IF( COM(1) .NE. 'Y' .AND. COM(1) .NE. 'N' ) GOTO 500
	IF( COM(1) .EQ. 'N' ) GOTO 1300
	DO 600 X = 1, 4
	    DO 600 Y = 1, 4
		DO 600 Z = 1, 4
		    MOVE( X, Y, Z ) = 0
600	CONTINUE
	DO 650 I = 1, TURN
	    MOVES( I, 1 ) = 0
650	CONTINUE
	TURN = 0
	GOTO 100

1000	CALL UPDSCR( MOVES, MOVE, .TRUE., .TRUE. )
	DO 1200 I = 1, 76
	    CALL CURSOR( 1, 2 )
	    CALL NUMBER( I+0, 2 )
	    CALL CHROUT(':')
	    DO 1150 J = 1, 4
		IVAL = WR( I, J )
		CALL NUMBER( IVAL, 4 )
		X = IVAL/100
		Y = IVAL/10 - 10*X
		Z = MOD( IVAL, 10 )
		MOVE( X, Y, Z ) = 3
1150	    CONTINUE
	    CALL UPDSCR( MOVES, MOVE, .FALSE., .TRUE. )
	    CALL CURSOR( 22, 2 )
	    CALL STRING('Go: ^B')
	    CALL CHRWAT( ICHAR )
	    DO 1170 J = 1, 4
		X = WR( I, J )/100
		Y = WR( I, J )/10 - 10*X
		Z = MOD( WR( I, J ), 10 )
		MOVE( X, Y, Z ) = 0
1170	    CONTINUE
1200	CONTINUE

1300	CALL CLOSE( 1 )
	CALL GRAFOF
	CALL PSTOP
	END
	SUBROUTINE UPDSCR( MOVES, MOVE, NEWSCR, COORD )

	IMPLICIT INTEGER ( A - Z )

	INTEGER MOVE( 4, 4, 4 ), OLDMOV( 4, 4, 4 ), MOVES( 64, 3 )
	LOGICAL NEWSCR, COORD, USED(64)
	INTEGER PIECES(5), COLORS(5)

	COMMON /COL/ICLWHI,ICLDBL,ICLRED,ICLLBL,
     &			ICLPUR,ICLGRE,ICLYEL,ICLBLA

	DATA PIECES/'.','X','O','+','@'/

	IF( COLORS(1) .NE. 0 ) GOTO 3
	COLORS(1) = ICLWHI
	COLORS(2) = ICLYEL
	COLORS(3) = ICLLBL
	COLORS(4) = ICLRED
	COLORS(5) = ICLPUR

3	IF( .NOT. NEWSCR ) GOTO 50
	CALL CLRSCR
	CALL CURSOR( 3, 24 )
	CALL STRING('X moves^M^J-------------^E')
	CALL CURSOR( 63, 24 )
	CALL STRING('O moves^E')
	CALL CURSOR( 61, 23 )
	CALL STRING('-------------^E')
	IF( .NOT. COORD ) GOTO 50
	DO 10 Y = 1, 4
	    DO 10 Z = 1, 4
		CALL CURSOR( 28-Y, 5*Z+Y-2 )
		CALL NUMBER( Y*10+Z )
		CALL CURSOR( 51-Y, 5*Z+Y-2 )
		CALL NUMBER( Y*10+Z )
10	CONTINUE
	CALL CURSOR( 31, 3 )
	DO 20 X = 1, 4
	    CALL NUMBER( X+0, 4 )
20	CONTINUE
	CALL CURSOR( 26, 23 )
	DO 30 X = 1, 4
	    CALL NUMBER( X+0, 4 )
30	CONTINUE

50	DO 100 X = 1, 4
	    DO 100 Y = 1, 4
		DO 100 Z = 1, 4
		    IF( .NOT. NEWSCR .AND.
     &			MOVE(X,Y,Z) .EQ. OLDMOV(X,Y,Z) ) GOTO 100
			OLDMOV(X,Y,Z) = MOVE(X,Y,Z)
			CALL CURSOR( 30+4*X-Y, 5*Z+Y-2 )
			CALL PCOLOR( COLORS(MOVE(X,Y,Z)+1) )
			CALL CHROUT( PIECES(MOVE(X,Y,Z)+1) )
100	CONTINUE

	DO 200 I = 1, 64
	    IF( NEWSCR ) USED(I) = .FALSE.
	    IF( (MOVES(I,1) .NE. 0 ) .EQ. USED(I) ) GOTO 200
	    USED(I) = (MOVES(I,1).NE.0)
	    IV = (I+1)/2
	    CALL CURSOR(MOD(I+1,2)*60+(IV/17)*8+1,22-MOD(IV-1,16))
	    IF( MOVES(I,1).EQ.0) CALL STRING('     ^E')
	    IF( MOVES(I,1).EQ.0) GOTO 200
	    CALL NUMBER( MOVES( I, 1 ) )
	    CALL NUMBER( -MOVES( I, 2 ) )
	    CALL NUMBER( -MOVES( I, 3 ) )
200	CONTINUE
	CALL PCOLOR( ICLWHI )
	IF( JOB(-1) .NE. 0 ) RETURN
	CALL UPDATE
	CALL NAP( 500, "14 )
	RETURN
	END
	SUBROUTINE GETMOV(COM,MOVE,WR,IPL,ICHAR,COORD,MOVES,TURN)

	IMPLICIT INTEGER ( A - Z )

	INTEGER MOVE( 4, 4, 4 ), WR( 76, 4 ), COM( 60 ), MOVES( 64, 3 )
	INTEGER TURN, IPL
	LOGICAL COORD, ERRFLG

	CALL CURSOR( 1, 1 )
	CALL STRING('                  ^E')
100	CALL CURSOR( 1, 2 )
	IF( IPL .EQ. 1 ) CALL CHROUT('X')
	IF( IPL .EQ. 2 ) CALL CHROUT('O')
	CALL STRING('''s move:                           ^E')
	IF( ICHAR .EQ. 'Y' ) GOTO 400
	CALL CURSOR( 12, 2 )
	CALL CURBUF
	CALL GETSTR( COM, 60, ILEN )
	IF( ILEN .EQ. 0 ) GOTO 100
	CALL ALLCAP( COM, ILEN )
	IF( COM(1) .EQ. 'G' ) ICHAR = 'Y'
	IF( COM(1) .EQ. 'G' .OR. COM(1) .EQ. 'M' ) GOTO 400
	IF( COM(1) .EQ. 'U' ) GOTO 1100
	IF( COM(1) .NE. 'E' ) GOTO 105
	CALL GRAFOF
	CALL TSTOP
	CALL GRAFON
105	IF( COM(1) .EQ. 'E' .OR. COM(1) .EQ. 'N' )
     &		CALL UPDSCR( MOVES, MOVE, .TRUE., COORD )
	IF( COM(1) .EQ. 'E' .OR. COM(1) .EQ. 'N' ) GOTO 100
	CALL GETNUM( COM, ILEN, X, 10, Y, 10, Z, 10 )
	Y = IABS( Y )
	Z = IABS( Z )
	IF( X.LT.111 .OR. X.GT.444 .OR. Y.NE.0 .OR. Z.NE.0 ) GOTO 125
	Z = MOD( X, 10 )
	Y = X/10 - 10*(X/100)
	X = X/100
125	IF(X.GE.1 .AND. X.LE.4 .AND. Y.GE.1 .AND. Y.LE.4
     &.AND. Z.GE.1 .AND. Z.LE.4) GOTO 150
	CALL CURSOR( 1, 1 )
	CALL STRING('^GIllegal move.     ^E')
	GOTO 100

150	IF( MOVE(X,Y,Z) .EQ. 0 ) GOTO 1000
	CALL CURSOR( 1, 1 )
	CALL STRING('^GAlready occupied. ^E')
	GOTO 100

400	IBEST = -99999999
	CALL CURSOR( 12, 2 )
	CALL STRING(' * Working *^B')
	DO 500 MX = 1, 4
	    DO 500 MY = 1, 4
		DO 500 MZ = 1, 4
		    ICH = IVALUE( MX+0, MY+0, MZ+0, MOVE, WR, IPL )
		    IF( ICH .LE. IBEST ) GOTO 500
		    IBEST = ICH
		    X = MX
		    Y = MY
		    Z = MZ
500	CONTINUE

1000	TURN = TURN + 1
	MOVES( TURN, 1 ) = X
	MOVES( TURN, 2 ) = Y
	MOVES( TURN, 3 ) = Z
	MOVE( X, Y, Z ) = IPL
	RETURN

1100	IF( TURN .EQ. 0 ) GOTO 1200
	MOVE( MOVES(TURN,1), MOVES(TURN,2), MOVES(TURN,3) ) = 0
	MOVES( TURN, 1 ) = 0
	TURN = TURN - 1
	IPL = 3-IPL
	CALL UPDSCR( MOVES, MOVE, .FALSE., COORD )
	GOTO 100

1200	CALL CURSOR( 1, 1 )
	CALL STRING('^GNo previous moves.^E')
	GOTO 100
	END
	SUBROUTINE EVAL( WR, MOVE, ROWTYP )

	IMPLICIT INTEGER ( A - Z )

	INTEGER WR( 76, 4 ), MOVE( 4, 4, 4 ), WIN(4,3)
	LOGICAL NOSTAL

	NOSTAL = .FALSE.
	DO 100 I = 1, 76
	    ROWTYP = 0
	    ROWVAL = 0
	    DO 50 J = 1, 4
		IVAL = WR( I, J )
		WIN(J,1) = IVAL/100
		WIN(J,2) = IVAL/10 - 10*WIN(J,1)
		WIN(J,3) = MOD( IVAL, 10 )
		IVAL = MOVE( WIN(J,1), WIN(J,2), WIN(J,3) )
		IF( IVAL .EQ. 3-ROWTYP ) GOTO 100
		IF( IVAL .GT. 0 ) ROWTYP = IVAL
		IF( IVAL .GT. 0 ) ROWVAL = ROWVAL + 1
50	    CONTINUE
	    IF( ROWVAL .GE. 4 ) GOTO 200
	    NOSTAL = .TRUE.
100	CONTINUE
	ROWTYP = 0
	IF( NOSTAL ) ROWTYP = -1
	RETURN

200	DO 300 I = 1, 4
	    MOVE( WIN(I,1), WIN(I,2), WIN(I,3) ) = ROWTYP + 2
300	CONTINUE
	RETURN
	END
	INTEGER FUNCTION IVALUE( X, Y, Z, MOVE, WR, IPL )

	IMPLICIT INTEGER ( A - Z )

	INTEGER X, Y, Z, WR( 76, 4 ), MOVE( 4, 4, 4 ), ROWTYP
	LOGICAL DANGER, WIN, TOINRO

	DANGER = .FALSE.
	WIN = .FALSE.
	IVALUE = -99999999
	IF( MOVE( X, Y, Z ) .NE. 0 ) RETURN
	IVALUE = 0
	XYZ = X*100+Y*10+Z
	DO 1000 I = 1, 76
	    TOINRO = .FALSE.
	    DO 100 J = 1, 4
		IF( WR( I, J ) .EQ. XYZ ) GOTO 200
100	    CONTINUE
	    GOTO 1000

200	    MYCONT = 0
	    HSCONT = 0
	    DO 300 J1 = 1, 4
		IVAL = WR( I, J1 )
		MX = IVAL/100
		MY = IVAL/10 - 10*MX
		MZ = MOD( IVAL, 10 )
		IVAL = MOVE( MX, MY, MZ )
		IF( IVAL .EQ. IPL ) MYCONT = MYCONT + 1
		IF( IVAL .EQ. 3-IPL ) HSCONT = HSCONT + 1
		IF( MYCONT*HSCONT .NE. 0 ) GOTO 1000
300	    CONTINUE
	    IF( MYCONT .EQ. 3 ) IVALUE = 999999999
	    IF( HSCONT .EQ. 3 ) IVALUE = IVALUE + 9999999
	    IF( HSCONT .EQ. 0 .AND. MYCONT .EQ. 2 ) TOINRO = .TRUE.
	    IF( WIN .AND. TOINRO ) IVALUE = IVALUE + 10000
	    IF( TOINRO ) WIN = .TRUE.
	    IF( MYCONT .EQ. 0 ) IVALUE = IVALUE + (HSCONT*10)^3
	    IF( HSCONT .EQ. 0 ) IVALUE = IVALUE  + (MYCONT*10)^3
	    IF( DANGER .AND. MYCONT .EQ. 0 ) IVALUE = IVALUE + 10000
	    IF( MYCONT .EQ. 0 .AND. HSCONT .GE. 2 ) DANGER = .TRUE.
1000	CONTINUE
	RETURN
	END
